{"version":3,"file":"component.esm.js","sources":["../lib/component.mjs"],"sourcesContent":["/**\n * Copyright (c) 2020-present, Yan Zhabin.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nconst __run__ = Symbol('__run__')\nconst __root__ = Symbol('__root__')\nconst __render__ = Symbol('__render__')\nconst __mounted__ = Symbol('__mounted__')\n\nconst isTagName = /^(\\w+)-(\\w+)$/\n\nconst method = {\n  validate: Symbol('validate'),\n  check: Symbol('check'),\n  init: Symbol('init')\n}\n\nexport const __state__ = Symbol('__state__')\nexport const __store__ = Symbol('__store__')\n\nconst __readonly__ = {\n  enumerable: false,\n  configurable: false,\n  writable: false\n}\n\n/**\n * \n * @param {Function|any} func \n */\nfunction isFunc(func) {\n  return func && typeof func === 'function'\n}\n\n/**\n * \n * @param {any} val1 \n * @param {any} val2 \n */\nfunction isEqual(val1, val2) {\n  if (Object.is(val1, val2)) return true\n  if (isFunc(val1) && isFunc(val2)) return val1.toString() === val2.toString()\n  if (Object.is(JSON.stringify(val1), JSON.stringify(val2))) return true\n  return false\n}\n\n/**\n * Attach global store\n * @param {<Record<string, unknown>>} store \n * @param {string} property \n * @returns {boolean}\n */\nexport function attachStore(store, property = __store__, onChange) {\n  // eslint-disable-next-line no-param-reassign\n  store.reflector = onChange || this.requestUpdate.bind(this)\n  Object.defineProperty(this, property, {\n    ...__readonly__,\n    value: store\n  })\n  return true\n}\n\n/**\n * Create local state of component. State changes initiate re-render\n * @param {<Record<string, unknown>>} state \n * @param {string} property \n * @param {Function|undefined} onChange \n */\nexport function createState(state, property = __state__, onChange) {\n  const self = this\n  const value = new Proxy({\n    ...state\n  }, {\n    /**\n     * \n     * @param {<Record<string, unknown>>} target \n     * @param {string} key\n     * @returns {any|undefined} \n     */\n    get(target, key) {\n      const property = target[key]\n      if (typeof property === 'object' && Object.prototype.hasOwnProperty.call(property, 'value')) {\n        return property.value\n      }\n      return undefined\n    },\n\n    /**\n     * \n     * @param {<Record<string, unknown>>} target \n     * @param {string} key \n     * @returns {boolean}\n     */\n    deleteProperty(target, key) {\n      delete target[key]\n      self.requestUpdate(undefined, key)\n      return true\n    },\n    /**\n     * \n     * @param {<Record<string, unknown>>} target \n     * @param {string} key \n     * @param {any} value\n     * @returns {boolean} \n     */\n    set(target, key, value) {\n      const property = target[key]\n      if (typeof property === 'object' && !isEqual(property.value, value)) {\n        if (property.type && typeof value !== typeof property.type()) {\n          throw new TypeError(`Wrong type of property \"${key}\".`)\n        }\n        property.value = value\n        if (typeof onChange === 'function') {\n          onChange(value, key)\n        } else if (self.requestUpdate) {\n          self.requestUpdate(value, key)\n        }\n        return true\n      }\n      return false\n    }\n  })\n\n  Object.defineProperty(this, property, {\n    ...__readonly__,\n    value\n  })\n}\n\n/**\n * @returns {void}\n */\nfunction bindRef() {\n  const self = this\n  Object.defineProperty(self, 'ref', {\n    ...__readonly__,\n    value: new Proxy({}, {\n      get(target, name) {\n        return self[__root__].querySelector('[ref=\"' + name + '\"]')\n      }\n    })\n  })\n}\n\n/**\n * \n */\nexport default class Component extends HTMLElement {\n  static get mode() {\n    return undefined\n  }\n\n  /**\n   * @param {Function} func\n   */\n  static set render(func) {\n    if (typeof func === 'function') {\n      this[__render__] = func\n    }\n  }\n\n  /**\n   * @returns {<Record<string, unknown>>|null}\n   */\n  get state() {\n    return this[__state__] || null\n  }\n\n  /**\n   * @returns {<Record<string, unknown>>|null}\n   */\n  get store() {\n    return this[__store__] || null\n  }\n\n  get root() {\n    return this[__root__]\n  }\n\n  /**\n   * \n   * @param args \n   */\n  constructor(...args) {\n    super(args)\n\n    const { state } = this.constructor\n\n    this[method.check]()\n    this[method.validate](state)\n    this[method.init](...args)\n\n    Component[__run__](['created'], this)\n  }\n\n  /**\n   * \n   * @param {string} tag \n   * @param {HTMLElement} point\n   * @param {boolean} once \n   * @throws {Error}\n   */\n  static mount(point = document.body, once = true) {\n    if (point instanceof HTMLElement && point.insertAdjacentHTML && this.tagName) {\n      if (once && document.querySelector(this.tagName)) {\n        return\n      }\n      point.insertAdjacentHTML('beforeend', `<${this.tagName} />`)\n    } else {\n      throw new Error('Static property tagName is required')\n    }\n  }\n\n  /**\n  * @returns {Component}\n  */\n  static define() {\n    const name = this.tagName\n\n    if (!isTagName.test(name)) {\n      throw new Error('Static property tagName is required')\n    }\n\n    if (!window.customElements.get(name)) {\n      window.customElements.define(name, this)\n    }\n    /** nativepack.ignore */\n    // eslint-disable-next-line no-undef\n    else if (module && module.hot) { // Hot Module Replacement\n      Array\n        .from(document.querySelectorAll(name))\n        .forEach(node => {\n          // Swap prototype of instance with new one\n          // https://github.com/polleverywhere/hmr-custom-element\n          Object.setPrototypeOf(node, this.prototype)\n          // re-render\n          if (node.requestUpdate) {\n            node.requestUpdate()\n          }\n        })\n    }\n    /** nativepack.ignore */\n    return this\n  }\n\n  /**\n   * Component life-cycles\n   * @param {Array<string>} lifeCycles \n   * @param {Component} instance \n   * @param args \n   * @returns {void}\n   */\n  static [__run__](lifeCycles, instance, args) {\n    lifeCycles.forEach(\n      lifeCycle => instance[lifeCycle]\n        && isFunc(instance[lifeCycle])\n        // eslint-disable-next-line prefer-spread\n        && instance[lifeCycle].apply(instance, args)\n    )\n  }\n\n  /**\n   * @returns {void}\n   */\n  [method.check]() {\n    const { mode, tagName } = this.constructor\n\n    if (!isTagName.test(tagName)) {\n      throw new Error('Static property tagName is required')\n    }\n\n    if (typeof this.constructor[__render__] !== 'function') {\n      console.warn('Renderer is undefined. For example you can use \"lit-html\" render function')\n    }\n\n    if (['open', 'closed'].includes(mode)) {\n      this[__root__] = this.attachShadow({\n        mode\n      })\n    }\n  }\n\n  /**\n   * @returns {void}\n   */\n  [method.init](...args) {\n    const { state, store, mixins } = this.constructor\n\n    this[__mounted__] = false\n\n    bindRef.call(this)\n\n    if (state && typeof state === 'object') {\n      createState.call(this, state)\n    }\n\n    if (store && typeof store === 'object') {\n      attachStore.call(this, store)\n    }\n\n    if (Array.isArray(mixins)) {\n      mixins.forEach(mixin => mixin.created && mixin.created.apply(this, args))\n    }\n  }\n\n  /**\n   * Validate state types\n   * @param {Record<string, unknown>} state\n   * @returns {void}\n   * @throws {TypeError}\n   */\n  [method.validate](state = {}) {\n    if (!state) return\n    const keys = Object.keys(state)\n    for (const key of keys) {\n      const property = state[key]\n\n      if (property.type && typeof property.value !== typeof property.type()) {\n        throw new TypeError(`Wrong type of property \"${key}\".`)\n      }\n    }\n  }\n\n  /**\n   * @returns {void}\n   */\n  adoptedCallback() {\n    const { mixins } = this.constructor\n\n    if (Array.isArray(mixins)) {\n      mixins.forEach(mixin => mixin.moved && mixin.moved.call(this))\n    }\n\n    Component[__run__](['moved', 'requestUpdate'], this)\n  }\n\n  /**\n   * @returns {void}\n   */\n  connectedCallback() {\n    const { mixins } = this.constructor\n\n    if (window.ShadyCSS !== undefined) {\n      window.ShadyCSS.styleElement(this)\n    }\n\n    this[__mounted__] = true\n\n    if (Array.isArray(mixins)) {\n      mixins.forEach(mixin => mixin.mounted && mixin.mounted.call(this))\n    }\n\n    Component[__run__](['mounted', 'requestUpdate'], this)\n  }\n\n  /**\n   * Optimize update\n   * @param args \n   * @returns {void}\n   */\n  attributeChangedCallback(...args) {\n    const [, oldValue, value] = args\n\n    if (this[__mounted__] && !isEqual(oldValue, value)) {\n      Component[__run__](['update', 'requestUpdate'], this, ...args)\n    }\n  }\n\n  /**\n   * Handle element unmount\n   * @returns {void}\n   */\n  disconnectedCallback() {\n    const { mixins } = this.constructor\n\n    if (Array.isArray(mixins)) {\n      mixins.forEach(mixin => mixin.unmounted && mixin.unmounted.call(this))\n    }\n\n    Component[__run__](['unmounted'], this)\n  }\n\n  /**\n   * Trigger re-render of element\n   * @returns {void}\n   */\n  async requestUpdate() {\n    const container = this.shadowRoot || this.root || this\n    const { __render__: renderer, styles } = this.constructor\n\n    await Component[__run__](['beforeUpdate'], this)\n\n    const template = await this.render()\n    const stylesTemplate = `<style>${this.constructor.styles}</style>`\n\n    if (renderer) {\n      if (String(styles).trim() && Array.isArray(template.strings)) {\n        const patched = [stylesTemplate, ...template.strings]\n        patched.raw = [stylesTemplate, ...template.strings.raw]\n        template.strings = patched\n      }\n\n      await renderer(template, container, {\n        eventContext: this\n      })\n    } else if (typeof template === 'string') {\n      container.innerHTML = styles + template\n    }\n\n    Component[__run__](['afterUpdate'], this)\n  }\n}\n"],"names":["__run__","Symbol","__root__","__render__","__mounted__","isTagName","method","__state__","__store__","__readonly__","enumerable","configurable","writable","isFunc","func","isEqual","val1","val2","Object","is","toString","JSON","stringify","attachStore","store","property","onChange","reflector","this","requestUpdate","bind","defineProperty","value","createState","state","self","Proxy","[object Object]","target","key","prototype","hasOwnProperty","call","deleteProperty","undefined","type","TypeError","bindRef","get","name","querySelector","Component","HTMLElement","mode","render","root","args","super","constructor","point","document","body","once","insertAdjacentHTML","tagName","Error","test","window","customElements","module","hot","Array","from","querySelectorAll","forEach","node","setPrototypeOf","define","lifeCycles","instance","lifeCycle","apply","console","warn","includes","attachShadow","mixins","isArray","mixin","created","keys","moved","ShadyCSS","styleElement","mounted","oldValue","unmounted","container","shadowRoot","renderer","styles","template","stylesTemplate","String","trim","strings","patched","raw","eventContext","innerHTML"],"mappings":"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"}